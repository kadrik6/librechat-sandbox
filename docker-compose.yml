version: "3.9"

services:
  api:
    container_name: LibreChat
    image: ghcr.io/danny-avila/librechat:latest
    restart: always
    ports:
      - "${PORT:-3080}:3080"
    env_file:
      - .env
    environment:
      - HOST=0.0.0.0
      - MONGO_URI=mongodb://mongodb:27017/LibreChat
      - MEILI_HOST=http://meilisearch:7700

      # --- RAG (ajutiselt välja lülitatud) ---
      # - RAG_PORT=${RAG_PORT:-8000}
      # - RAG_API_URL=http://rag_api:${RAG_PORT:-8000}

    depends_on:
      - mongodb
      - meilisearch
      # - rag_api   # RAG ajutiselt väljas

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      # (logs ei mounti – see vältis permission errorit)
      - ./images:/app/client/public/images
      - ./uploads:/app/uploads
      # - ./logs:/app/logs
      - ./librechat.yaml:/app/librechat.yaml


  mongodb:
    container_name: chat-mongodb
    image: mongo:6.0
    restart: always
    command: mongod --noauth
    tmpfs:
      - /data/db

  meilisearch:
    container_name: chat-meilisearch
    image: getmeili/meilisearch:v1.12.3
    restart: always
    environment:
      - MEILI_NO_ANALYTICS=true
      - MEILI_ENV=development
    tmpfs:
      - /meili_data

  # ---------- RAG STACK (AJUTISELT VÄLJAS) ----------

  # rag_api:
  #   container_name: rag_api
  #   image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
  #   restart: always
  #   env_file:
  #     - .env
  #   environment:
  #     - RAG_PORT=${RAG_PORT:-8000}
  #   depends_on:
  #     - vectordb
  #   ports:
  #     - "8000:8000"

  # vectordb:
  #   container_name: vectordb
  #   image: pgvector/pgvector:0.8.0-pg15
  #   restart: always
  #   environment:
  #     POSTGRES_DB: rag
  #     POSTGRES_USER: rag
  #     POSTGRES_PASSWORD: rag
  #   ports:
  #     - "5432:5432"
